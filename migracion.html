<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Migraciones y Cancelaciones</title>
<style>
  body { 
    font-family: Arial, sans-serif; 
    background: #F4F9FB; 
    margin:0; padding:20px; 
    display:flex; justify-content:center; align-items:flex-start; 
    min-height:100vh; 
    transition: background 0.3s, color 0.3s; 
  }
  .container { 
    background:#fff; 
    padding:20px 30px; 
    border-radius:14px; 
    box-shadow:0px 6px 14px rgba(0,0,0,0.1); 
    width:90%; max-width:1000px; 
    box-sizing:border-box; 
    transition: background 0.3s, color 0.3s; 
  }
  h1 { text-align:center; color:#01768b; margin-bottom:10px; font-size:28px; font-weight:bold; }
  h1 + hr { border:0; height:4px; background:#fbf32f; border-radius:3px; margin-bottom:20px; }
  details { margin-bottom:25px; border:1px solid #ccc; border-radius:8px; padding:10px 15px; background:#fafafa; transition: background 0.3s; }
  details summary { font-weight:bold; cursor:pointer; color:#0c477e; font-size:16px; }
  details p { margin:10px 0; font-size:15px; color:#333; }
  h2 { color:#0c477e; font-size:20px; margin-top:20px; border-bottom:3px solid #fbf32f; display:inline-block; padding-bottom:3px; }
  h3 { border-bottom:2px solid #fbf32f; padding-bottom:4px; }

  .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .input-group { display: flex; flex-direction: column; }
  .input-group label { font-size: 14px; margin-bottom: 5px; font-weight: 500; color: #333; transition: color 0.3s; }
  input, select { width: 100%; padding: 10px; font-size: 14px; border: 1.5px solid #ccc; border-radius: 8px; outline: none; transition: 0.3s; background: #fff; box-sizing:border-box; min-height: 38px; color:#333; }
  input:focus, select:focus { border-color: #01768b; background: #f8ffff; }
  .input-with-mark { display:flex; align-items:center; gap:4px; }
  .input-with-mark span { color:#000; transition: color 0.3s; }

  .dni-container { display:flex; gap:10px; }
  .dni-container input { flex:1; padding:10px; border:1.5px solid #ccc; border-radius:8px; font-size:14px; }
  .dni-container button { padding:10px 15px; background:#01768b; border:none; border-radius:8px; color:white; cursor:pointer; transition:0.3s; }
  .dni-container button:hover { background:#0c477e; }

  .buttons { margin-top:25px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
  .buttons button { padding:12px 24px; border:none; border-radius:8px; cursor:pointer; font-weight:500; transition:0.3s; font-size:15px; background:#01768b; color:white; }
  .buttons button:hover { background:#0c477e; box-shadow:0 0 8px #fbf32f; }

  #mensaje { margin-top:25px; text-align:center; font-size:15px; font-weight:500; color:#01768b; }
  #speech { margin-top:25px; padding:15px; border:1px dashed #01768b; border-radius:8px; background:#fdfdfd; display:none; color:#333; }
  #speech h3 { margin-top:0; margin-bottom:10px; color:#0c477e; font-size:20px; font-weight:bold; }
  #speech .green { color:#01768b; font-weight:bold; }
  .blue { color:#0c477e; }

  .plan-details { margin-top:15px; padding:15px; border:1px solid #ccc; border-radius:8px; background:#fafafa; display:none; transition: background 0.3s; }
  .plan-details.show { display:block; }
  .plan-details .row { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .plan-details .col { padding:10px; background:#fff; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
  .plan-details h3 { margin-top:0; color:#01768b; font-size:16px; }

  /* Bloque autofill con animación y estilo */
  .autofill { 
    overflow: hidden; 
    max-height: 0; 
    opacity: 0; 
    transition: max-height 0.5s ease, opacity 0.5s ease; 
    background: #e7f7f9; 
    border: 1px solid #01768b; 
    border-radius: 10px; 
    padding: 0 15px; 
    margin-top: 15px;
    position: relative;
  }
  .autofill.show { 
    max-height: 500px; 
    opacity: 1; 
    padding: 15px; 
  }
  .autofill .input-row { margin-bottom: 10px; }
  .autofill button { 
    background:#c62828; 
    color:white; 
    padding:6px 12px; 
    border:none; 
    border-radius:6px; 
    cursor:pointer; 
    margin-top:10px;
  }
  .autofill button:hover { background:#a61c1c; }

  /* Loader (spinner) dentro del autofill */
  .loader {
    border: 4px solid rgba(0,0,0,0.08);
    border-top: 4px solid #01768b;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    animation: spin 1s linear infinite;
    margin: 8px auto 12px auto;
    display: none;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* Modal confirmación */
  .modal { display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal.show { display:flex; }
  .modal-content { background:#fff; padding:25px; border-radius:12px; text-align:center; max-width:400px; box-shadow:0 6px 14px rgba(0,0,0,0.2); color:#333; }
  .modal-content h2 { color:#0c477e; margin-bottom:15px; }
  .modal-buttons { display:flex; justify-content:center; gap:15px; margin-top:20px; flex-wrap:wrap; }
  .modal-buttons button { padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:500; color:#fff; }
  .btn-yes { background:#01768b; } .btn-yes:hover { background:#0c477e; box-shadow:0 0 6px #fbf32f; }
  .btn-no { background:#c62828; } .btn-no:hover { background:#a61c1c; }

  /* Switch modo oscuro */
  .switch { position: relative; display: inline-block; width: 50px; height: 25px; }
  .switch input { display:none; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 25px; }
  .slider:before { position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #fbf32f; }
  input:checked + .slider:before { transform: translateX(24px); }

  /* Estilos modo oscuro */
  body.dark-mode { background-color: #121212; color: #f1f1f1; }
  body.dark-mode .container { background:#1e1e1e; color:#f1f1f1; }
  body.dark-mode input, 
  body.dark-mode select { background-color: #222; color:#f1f1f1; border: 1px solid #666; }
  body.dark-mode .input-group label,
  body.dark-mode .input-with-mark span,
  body.dark-mode details p,
  body.dark-mode details summary { color:#f1f1f1; }
  body.dark-mode details { background:#1c1c1c; border-color:#555; }
  body.dark-mode .plan-details { background:#1c1c1c; border-color:#555; }
  body.dark-mode .plan-details .col { background:#2a2a2a; }
  body.dark-mode .autofill { background:#1c2b30; border-color:#fbf32f; }
  body.dark-mode .modal-content { background:#1e1e1e; color:#f1f1f1; }
  body.dark-mode h1, 
  body.dark-mode h2, 
  body.dark-mode h3 { color:#fbf32f; }
  body.dark-mode #speech { background:#1c1c1c; border-color:#fbf32f; color:#eee; }
  body.dark-mode #speech h3 { color:#fbf32f; }
  body.dark-mode #mensaje { color:#fbf32f; }
  body.dark-mode .blue { color:#4eaaff; }
  body.dark-mode .green { color:#a6ff8a; }

  @media (max-width:768px){ 
    .input-row { grid-template-columns: 1fr; } 
    .plan-details .row { grid-template-columns:1fr; } 
    .buttons button, .modal-buttons button { width:100%; } 
  }
</style>
</head>
<body>

<!-- Switch de modo oscuro -->
<div style="position: absolute; top: 15px; right: 20px;">
  <label class="switch">
    <input type="checkbox" id="darkSwitch">
    <span class="slider"></span>
  </label>
</div>

<div class="container">
<h1>Migraciones y Cancelaciones</h1>

<details>
  <summary>Presentación:</summary>
  <p>1. “Hola, te habla <span class="blue">(Nombre del agente)</span> de Bitel. ¿Me brindaría su nombre por favor?"</p>
  <p>2. <span class="blue">(Nombre del cliente)</span>, ¿Qué operación va a realizar?</p>
  <p>3. “El número que llama es el que quiere migrar el que termina en <span class="blue">XXXX</span>”</p>
  <p>4. "¿Podrías indicarme el motivo de la migración de este número y a qué plan deseas cambiarte?"</p>
</details>

<h2>Llenado de datos</h2>
<form id="miFormulario" action="https://script.google.com/macros/s/AKfycbzq3MWR3rI5ZkLNlkwOs6PuHNx9ipVRpeesOmS2XbtE7olSWHfO-V757wQ7tLJpsvHlbA/exec" method="post" target="hidden_iframe">
  <input type="hidden" name="token" value="BitelMigracion2025SuperClave">

  <div class="input-row">
    <div class="input-group">
      <label for="telefonoEntrante">Teléfono entrante</label>
      <input type="number" name="telefonoEntrante" id="telefonoEntrante" placeholder="9 dígitos" required maxlength="9" oninput="this.value=this.value.slice(0,9)">
    </div>

    <div class="input-group">
      <label for="telefonoSolicitud">Teléfono de solicitud</label>
      <input type="number" name="telefonoSolicitud" id="telefonoSolicitud" placeholder="9 dígitos" required maxlength="9" oninput="this.value=this.value.slice(0,9)">
    </div>
  </div>


  <!-- DNI + lupa -->
  <div class="input-row">
    <div class="input-group">
      <label for="dni">Número de documento de identidad</label>
      <div class="dni-container">
        <input type="number" name="dni" id="dni" required >
      </div>
    </div>
  </div>

  <!-- Autofill (debajo del DNI con animación y fondo bonito) -->
  <div class="autofill" id="autofill">
    <div class="loader" id="loader"></div>
    <div class="input-row">
      <div class="input-group"><label for="nombre">Nombre completo</label><input type="text" id="nombre" readonly></div>
      <div class="input-group"><label for="fechaNacimiento">Fecha de nacimiento</label><input type="text" id="fechaNacimiento" readonly></div>
      <div class="input-group"><label for="ubicacion">Departamento - Provincia - Distrito</label><input type="text" id="ubicacion" readonly></div>
    </div>
  </div>
<button type="button" onclick="buscarDNI()">🔍</button>
<button type="button" onclick="ocultarDNI()">Ocultar datos ✖</button>

<br><br>

  <div class="input-row">
    <div class="input-group">
      <label for="usuarioAgente">Usuario de agente</label>
      <input type="text" name="usuarioAgente" id="usuarioAgente" placeholder="cpc_xxxxxx_vtp" style="text-transform: lowercase;" required>
    </div>

    <div class="input-group">
      <label for="idEntrante">ID de llamada</label>
      <div class="input-with-mark">
        <input type="text" name="idEntrante" id="idEntrante" placeholder="ID directo" required>
      </div>
    </div>


    <div class="input-group">
      <label for="motivo">Motivo de migración</label>
      <select name="motivo" id="motivo" required>
        <option value="">Seleccione...</option>
        <option value="Motivo 1">Motivo 1</option>
        <option value="Motivo 2">Motivo 2</option>
        <option value="Motivo 3">Motivo 3</option>
      </select>
    </div>

    <div class="input-group">
      <label for="plan">Plan deseado a migrar</label>
      <select name="plan" id="plan" onchange="mostrarPlan()" required>
        <option value="">Seleccione:</option>
        <option value="Prepago Bifri5">Prepago Bifri5</option>
        <option value="Ilimitado 29.90">Ilimitado 29.90</option>
      </select>
    </div>
  </div>

  <div class="plan-details" id="planDetails">
    <div class="row">
      <div class="col"><h3>🗣️ 1. Speech - Detalle de beneficios</h3><div id="detalle"></div></div>
      <div class="col"><h3>🗣️ 2. Speech - Detalle de consideraciones</h3><div id="consideraciones"></div></div>
    </div>
  </div>

  <div class="buttons">
    <button type="submit">Guardar</button>
    <button type="button" onclick="limpiar()">Limpiar</button>
  </div>
</form>

<div id="mensaje"></div>
<div id="speech"></div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

<!-- Modal -->
<div class="modal" id="modalConfirm">
  <div class="modal-content">
    <h2>¿Desea guardar la información?</h2>
    <div class="modal-buttons">
      <button class="btn-yes" id="btnYes">Sí</button>
      <button class="btn-no" id="btnNo">No</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Variables & Listeners base
   --------------------------- */
const TOKEN = "cGVydWRldnMucHJvZHVjdGlvbi5maXRjb2RlcnMuNjhkMDQ2ODM3NzAwMmUxM2U0NzI4YWM0";
let telefonoSolicitud, plan, codigo;

const telefonoSolicitudEl = document.getElementById("telefonoSolicitud");
if (telefonoSolicitudEl) {
  telefonoSolicitudEl.addEventListener("input", function(){
    telefonoSolicitud = this.value;
  });
}
const planEl = document.getElementById("plan");
if (planEl) {
  planEl.addEventListener("change", function(){
    plan = this.value;
  });
}

const formulario = document.getElementById("miFormulario");
const modal = document.getElementById("modalConfirm");
const btnYes = document.getElementById("btnYes");
const btnNo = document.getElementById("btnNo");

/* Al enviar el formulario: mostrar modal */
if (formulario) {
  formulario.addEventListener("submit", function(e){
      e.preventDefault();
      modal.classList.add("show");
  });
}

/* Si confirma: enviar form via fetch (mismo comportamiento que tenías) */
if (btnYes) {
  btnYes.addEventListener("click", function(){
      modal.classList.remove("show");

      // Agregar símbolos al ID
      const idInput = document.getElementById("idEntrante");
      idInput.value = `$$_${idInput.value}_&&`;

      // Enviar datos con fetch en lugar de submit directo
      const formData = new FormData(formulario);
      fetch(formulario.action, {
          method: "POST",
          body: formData
      })
      .then(res => res.text())
      .then(txt => {
          mostrarMensaje(txt);
      })
      .catch(err => {
          document.getElementById("mensaje").innerHTML = "❌ Error al guardar los datos: " + err;
      });
  });
}

/* Si cancela guardar */
if (btnNo) {
  btnNo.addEventListener("click", function(){
      modal.classList.remove("show");
  });
}

/* ---------------------------
   Mensajes, limpiar, plan
   --------------------------- */
function mostrarMensaje(respuesta){
    const regex = /Código:\s*(MIG\d+)/;
    const match = respuesta.match(regex);
    const codigo = match ? match[1] : "N/A";

    document.getElementById("mensaje").innerHTML = `✅ Datos guardados correctamente.<br><span class="codigo">🔐 Código de solicitud: ${codigo}</span>`;
    document.getElementById("speech").style.display = "block";
    document.getElementById("speech").innerHTML = `
        <h3>🗣️ Speech de confirmación:</h3>
        <p>“Se ha gestionado la migración de su línea <span class="green">${telefonoSolicitud}</span> al plan <span class="green">${plan}</span>. El cambio se realizará en un máximo de 24 horas. Cuando pierda señal, reinicie su equipo y haga una llamada para activar el servicio.</p>
        <p>El código de solicitud es <span class="green">${codigo}</span> y lo recibirá por SMS y/o email.</p>
        <p>“Eso sería todo de mi parte, gracias por comunicarse. En breve recibirá una encuesta por SMS para calificar mi atención. Que tenga un excelente día.”</p>
    `;
}

function limpiar(){
    formulario.reset();
    document.getElementById("planDetails").classList.remove("show");
    document.getElementById("speech").style.display = "none";
    document.getElementById("mensaje").innerHTML = "";
    // NOTA: no ocultamos el autofill automáticamente para respetar tu estructura (usuario puede usar "Ocultar datos")
}

/* Lógica para mostrar detalles del plan (tu contenido original) */
function mostrarPlan(){
  const planSelect = document.getElementById("plan").value;
  const detalle = document.getElementById("detalle");
  const consideraciones = document.getElementById("consideraciones");
  const planDetails = document.getElementById("planDetails");

    if (planSelect === "Prepago Bifri5") {
    detalle.innerHTML = `
      <p>Estos beneficios se brindan automáticamente por migrar a prepago, el bono se otorga por única vez y no es necesario que realice una recarga:</p>
      <ul>
        <li>Llamadas y SMS ilimitados a todo destino nacional</li>
        <li>650 MB de libre uso + navegación ilimitada a velocidad reducida</li>
        <li>1.5 GB en alta velocidad para WhatsApp + navegación ilimitada a velocidad reducida</li>
        <li>1.5 GB en alta velocidad para: Waze, Mobile Legends, Garena Free Fire</li>
        <li>1 GB en alta velocidad para: YouTube, TikTok, Viki, América TVGO</li>
        <li>Facebook e Instagram (versión full)</li>
        <li>Vigencia del bono: 5 días.</li>
      </ul>
      <p><strong>¿Estaría de acuerdo en realizar la migración al plan prepago Bifri5?</strong></p>
    `;
    consideraciones.innerHTML = `
      <p>Sr. [Nombre del cliente], la migración es gratuita, mantiene su chip y se ejecuta en un máximo de 24 horas</p>
      <ul>
        <li>Puede desistir en un plazo de 40 días útiles</li>
        <li>Debe estar al día en sus pagos, ya que la migración no exime de deudas ni penalidades</li>
        <li>Este proceso no permite adquirir equipos</li>
        <li>Su línea debe estar activa y sin bloqueos</li>
        <li>Conservará sus puntos Bitel no vencidos, pero perderá los beneficios del plan anterior y recibirá los del nuevo</li>
      </ul>
      <p><strong>¿Está de acuerdo con realizar la migración?</strong></p>
    `;
    planDetails.classList.add("show");

  } else if (planSelect === "Ilimitado 29.90") {
    detalle.innerHTML = `
      <ul>
        <li>Llamadas ilimitadas a todo operador</li>
        <li>10GB de alta velocidad</li>
        <li>WhatsApp ilimitado</li>
      </ul>
    `;
    consideraciones.innerHTML = `
      <ul>
        <li>Velocidad reducida después de 10GB</li>
        <li>No incluye roaming</li>
        <li>Costo fijo mensual S/29.90</li>
      </ul>
    `;
    planDetails.classList.add("show");

  } else {
    planDetails.classList.remove("show");
  }
}

/* ---------------------------
   BÚSQUEDA DNI -> API PeruDevs
   - muestra loader dentro del autofill mientras consulta
   - si API responde: llena campos (nombre, fecha, ubicacion si aplica)
   - si falla: usar fallback (datos ficticios)
   --------------------------- */
async function buscarDNI(){
  const dni = document.getElementById("dni").value.trim();
  if(dni.length !== 8){ alert("Ingrese un DNI válido de 8 dígitos"); return; }

  const autofill = document.getElementById("autofill");
  const loader = document.getElementById("loader");
  const nombreEl = document.getElementById("nombre");
  const fechaEl = document.getElementById("fechaNacimiento");
  const ubicacionEl = document.getElementById("ubicacion");

  // Mostrar autofill y loader
  autofill.classList.add("show");
  loader.style.display = "block";

  // Vaciar o mostrar texto provisional
  nombreEl.value = "Buscando...";
  fechaEl.value = "Buscando...";
  ubicacionEl.value = "Buscando...";

  try {
    const resp = await fetch(`https://api.perudevs.com/api/v1/dni/complete?document=${dni}&key=${TOKEN}`);
    if(!resp.ok){
      throw new Error("HTTP " + resp.status);
    }
    const data = await resp.json();

    if(data && data.estado && data.resultado){
      const r = data.resultado;

      // Nombre y fecha — si no vienen, dejamos "No disponible"
      nombreEl.value = r.nombre_completo || r.nombres || "No disponible";
      fechaEl.value = r.fecha_nacimiento || "No disponible";

      // Ubicación: la API de ejemplo no trae departamento/provincia/distrito,
      // pero dejamos la lógica preparada por si la API los devuelve con estas keys.
      const dept = r.departamento || r.departamento_nombre || r.departamentoName || "";
      const prov = r.provincia || r.provincia_nombre || r.provinciaName || "";
      const dist = r.distrito || r.distrito_nombre || r.distritoName || "";

      if(dept || prov || dist){
        const d = dept || "No disponible";
        const p = prov || "No disponible";
        const di = dist || "No disponible";
        ubicacionEl.value = `${d} - ${p} - ${di}`;
      } else {
        // si no existen campos de ubicación en la respuesta, mostramos "No disponible"
        ubicacionEl.value = r.ubigeo || "No disponible";
      }
    } else {
      // no encontrado: usar fallback ficticio
      usarFallback();
    }
  } catch (err) {
    console.error("Error al consultar la API RENIEC:", err);
    // fallback
    usarFallback();
  } finally {
    // ocultar loader
    document.getElementById("loader").style.display = "none";
  }
}

/* Fallback: datos ficticios (como pediste) */
function usarFallback(){
  document.getElementById("nombre").value = "Juan Perez";
  document.getElementById("fechaNacimiento").value = "15/08/1990";
  document.getElementById("ubicacion").value = "Lima - Lima - San Isidro";
  document.getElementById("loader").style.display = "none";
  document.getElementById("autofill").classList.add("show");
}

/* Ocultar el bloque autofill cuando el usuario pulse la X */
function ocultarDNI(){
  document.getElementById("autofill").classList.remove("show");
}

/* ---------------------------
   Switch modo oscuro
   --------------------------- */
document.getElementById("darkSwitch").addEventListener("change", function(){
    document.body.classList.toggle("dark-mode", this.checked);
});
</script>

</body>
</html>
